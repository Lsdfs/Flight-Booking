<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Select Additional Baggage</title>
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf != null}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf != null}"/>
    <link rel="stylesheet" th:href="@{/css/baggage.css}">
    <style>

    </style>
</head>
<body>
<div id="applyReturnPopup" class="popup hidden">
    <p>Do you want to apply this baggage selection for the return trip?</p>
    <button onclick="applyToReturnTrip(true)">Yes</button>
    <button onclick="applyToReturnTrip(false)">No</button>
</div>

<div th:fragment="baggageModal" id="baggageModal" class="modal">
    <div class="head-container">
        <h2 class="head-content">Select luggage</h2>
    </div>

    <div id="errorMessage" class="error-message" th:text="${error}"></div>
    <form id="baggageForm" th:action="@{/baggage/save}" method="post">
        <input type="hidden" name="bookingId" th:value="${bookingId}"/>
        <input type="hidden" name="flightId" th:value="${departFlight?.id}"/>
        <input type="hidden" id="applyToReturnTrip" name="applyToReturnTrip" th:value="${applyToReturnTrip}"/>
        <div class="tab-container" id="baggageTabs">
            <div class="tab active" onclick="changeTab('baggage', 'depart')">Depart trip</div>
            <div class="tab" id="returnBaggageTab" onclick="changeTab('baggage', 'return')">Return trip</div>
        </div>

        <div id="departBaggage">
            <div class="passenger-info">
                <p th:text="${passengerName != null ? passengerName : 'Unknown Passenger'}"></p>
                <p th:text="${departFlight?.departure} + ' - ' + ${departFlight?.destination}"></p>
            </div>

            <div class="free-baggage-info">
                <p th:text="'Your ticket class (' + ${departFlight?.ticketClass?.name} + ') includes ' + ${departFlight?.ticketClass?.freeBaggageWeight * booking.passengerCount} + ' kg of free Standard baggage. Additional fees may apply for excess weight or Extra baggage.'"></p>
            </div>
            <h3>Add more baggage</h3>
            <div th:if="${#lists.isEmpty(baggageOptions)}">
                <p class="not-found-mes">No baggage options available.</p>
            </div>
            <div th:unless="${#lists.isEmpty(baggageOptions)}">
                <div th:each="baggage : ${baggageOptions}" class="baggage-option">
                    <div>
                        <img src="/image/baggage.png" alt="Baggage"/>
                        <span th:text="${baggage.weight + ' kg (' + baggage.category + ')'}"></span>
                    </div>
                    <div>
                        <span th:classappend="${baggage.category != 'Standard'} ? 'baggage-price' : ''"
                              th:text="${'Price per kg: ' + #numbers.formatInteger(baggage.pricePerKg, 0, 'COMMA') + ' VND'}"></span>
                        <div class="quantity-controls">
                            <button type="button" th:onclick="'updateQuantity(\'depart-' + ${baggage.id} + '\', -1)'">-</button>
                            <span th:id="'depart-quantity-' + ${baggage.id}" class="quantity"
                                  th:text="${selectedDepartBaggage[baggage.id] ?: 0}"></span>
                            <input type="hidden" th:name="'departBaggage[' + ${baggage.id} + ']'" th:id="'depart-' + ${baggage.id}"
                                   th:value="${selectedDepartBaggage[baggage.id] ?: 0}"/>
                            <button type="button" th:onclick="'updateQuantity(\'depart-' + ${baggage.id} + '\', 1)'">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="returnBaggage" class="hidden" th:if="${returnFlight != null}">
            <div class="passenger-info">
                <p th:text="${passengerName != null ? passengerName : 'Unknown Passenger'}"></p>
                <p th:text="${returnFlight?.departure} + ' - ' + ${returnFlight?.destination}"></p>
            </div>
            <div class="free-baggage-info">
                <p th:text="'Your ticket class (' + ${returnFlight?.ticketClass?.name} + ') includes ' + ${returnFlight?.ticketClass?.freeBaggageWeight * booking.passengerCount} + ' kg of free Standard baggage. Additional fees may apply for excess weight or Extra baggage.'"></p>
            </div>
            <h3>Add more baggage</h3>
            <div th:if="${#lists.isEmpty(baggageOptions)}">
                <p>No baggage options available.</p>
            </div>
            <div th:unless="${#lists.isEmpty(baggageOptions)}">
                <div th:each="baggage : ${baggageOptions}" class="baggage-option">
                    <div>
                        <img src="/image/baggage.png" alt="Baggage"/>
                        <span th:text="${baggage.weight + ' kg (' + baggage.category + ')'}"></span>
                    </div>
                    <div>
                        <span th:classappend="${baggage.category != 'Standard'} ? 'baggage-price' : ''"
                              th:text="${'Price per kg: ' + #numbers.formatInteger(baggage.pricePerKg, 0, 'COMMA') + ' VND'}"></span>
                        <div class="quantity-controls">
                            <button type="button" th:onclick="'updateQuantity(\'return-' + ${baggage.id} + '\', -1)'">-</button>
                            <span th:id="'return-quantity-' + ${baggage.id}" class="quantity"
                                  th:text="${selectedReturnBaggage[baggage.id] ?: 0}"></span>
                            <input type="hidden" th:name="'returnBaggage[' + ${baggage.id} + ']'" th:id="'return-' + ${baggage.id}"
                                   th:value="${selectedReturnBaggage[baggage.id] ?: 0}"/>
                            <button type="button" th:onclick="'updateQuantity(\'return-' + ${baggage.id} + '\', 1)'">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-bottom">
            <button type="button" onclick="showApplyReturnPopup()">Confirm</button>
            <button type="submit" class="no-thanks" onclick="skipSelection()">No, thanks</button>
        </div>

    </form>
</div>

<script>
    let selectedDepartBaggage = {};
    let selectedReturnBaggage = {};

    document.addEventListener('click', function(event) {
        const modal = document.getElementById('baggageModal');
        const applyReturnPopup = document.getElementById('applyReturnPopup');

        if (modal && !modal.contains(event.target) && !applyReturnPopup.contains(event.target) && !modal.classList.contains('hidden')) {
            closeModal('baggageModal');
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quantity-btn')) {
            const direction = e.target.dataset.direction;
            const baggageId = e.target.dataset.baggageId;
            const tab = e.target.dataset.tab;
            updateQuantity(tab, baggageId, direction === 'plus' ? 1 : -1);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const applyToReturnTrip = document.getElementById('applyToReturnTrip')?.value;
        const returnFlightExists = /*[[${returnFlight != null}]]*/ false;

        if (applyToReturnTrip !== 'yes' || !returnFlightExists) {
            document.getElementById('returnBaggageTab').style.display = 'none';
            document.getElementById('returnBaggage').style.display = 'none';
        }

        document.querySelectorAll('#departBaggage input[type="hidden"]').forEach(input => {
            const baggageId = input.id.split('-')[1];
            selectedDepartBaggage[baggageId] = parseInt(input.value) || 0;
        });

        document.querySelectorAll('#returnBaggage input[type="hidden"]').forEach(input => {
            const baggageId = input.id.split('-')[1];
            selectedReturnBaggage[baggageId] = parseInt(input.value) || 0;
        });
    });

    function changeTab(type, tab) {
        const returnBaggageTab = document.getElementById('returnBaggageTab');
        if (tab === 'return' && returnBaggageTab.style.display === 'none') {
            return;
        }

        if (tab === 'depart') {
            document.getElementById('departBaggage').classList.remove('hidden');
            document.getElementById('returnBaggage').classList.add('hidden');
            document.querySelector('#baggageTabs .tab:nth-child(1)').classList.add('active');
            document.querySelector('#baggageTabs .tab:nth-child(2)').classList.remove('active');
        } else {
            document.getElementById('departBaggage').classList.add('hidden');
            document.getElementById('returnBaggage').classList.remove('hidden');
            document.querySelector('#baggageTabs .tab:nth-child(1)').classList.remove('active');
            document.querySelector('#baggageTabs .tab:nth-child(2)').classList.add('active');
        }
    }

    let autoSaveTimeout;
    function updateQuantity(inputId, delta) {
        const [tab, baggageId] = inputId.split('-');
        const selectedBaggage = tab === 'depart' ? selectedDepartBaggage : selectedReturnBaggage;
        const quantityElement = document.getElementById(`${tab}-quantity-${baggageId}`);
        const inputElement = document.getElementById(inputId);

        let currentQuantity = parseInt(quantityElement.textContent) || 0;
        currentQuantity = Math.max(0, currentQuantity + delta);
        selectedBaggage[baggageId] = currentQuantity;

        quantityElement.textContent = currentQuantity.toString();
        inputElement.value = currentQuantity.toString();

        clearError();

        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            autoSaveSelections();
        }, 1000);
    }

    function autoSaveSelections() {
        const bookingId = document.querySelector('input[name="bookingId"]')?.value;
        if (!bookingId) {
            console.error('Booking ID not found for auto-save');
            return;
        }

        fetch('/baggage/autosave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content
            },
            body: JSON.stringify({
                bookingId: bookingId,
                departBaggage: selectedDepartBaggage,
                returnBaggage: selectedReturnBaggage
            })
        }).then(response => {
            if (!response.ok) {
                return response.text().then(errorMessage => {
                    throw new Error(errorMessage);
                });
            }
            return response.text();
        }).then(message => {
            console.log(message);
            clearError();
        }).catch(error => {
            console.error('Auto-save failed:', error.message);
            displayError(error.message);
        });
    }

    function showApplyReturnPopup() {
        const returnBaggageDiv = document.getElementById('returnBaggage');
        const applyToReturnTrip = document.getElementById('applyToReturnTrip')?.value;

        if (returnBaggageDiv && !returnBaggageDiv.classList.contains('hidden')
            && applyToReturnTrip === 'yes') {
            document.getElementById('applyReturnPopup').classList.remove('hidden');
            document.getElementById('applyReturnPopup').style.zIndex = '1000';
        } else {
            submitForm(false);
        }
    }

    function getBaggageIdFromInputId(inputId) {
        const parts = inputId.split('-');
        if (parts.length < 2) {
            console.error(`Invalid input ID format: ${inputId}`);
            return null;
        }
        return parts[1];
    }

    function prepareFormData() {
        Object.entries(selectedDepartBaggage).forEach(([baggageId, quantity]) => {
            const input = document.getElementById(`depart-${baggageId}`);
            if (input) input.value = quantity.toString();
        });

        Object.entries(selectedReturnBaggage).forEach(([baggageId, quantity]) => {
            const input = document.getElementById(`return-${baggageId}`);
            if (input) input.value = quantity.toString();
        });
    }

    function submitForm(applyToReturn) {
        prepareFormData();
        document.getElementById('baggageForm').submit();
    }

    function applyToReturnTrip(apply) {

        document.getElementById('applyReturnPopup').classList.add('hidden');
        if (apply) {
            document.querySelectorAll('#returnBaggage input[type="hidden"]').forEach(input => {
                input.value = "0";
                const baggageId = getBaggageIdFromInputId(input.id);
                if (baggageId) {
                    document.getElementById(`return-quantity-${baggageId}`).textContent = "0";
                }
            });

            selectedReturnBaggage = { ...selectedDepartBaggage };
            Object.entries(selectedReturnBaggage).forEach(([baggageId, quantity]) => {
                const returnInput = document.getElementById(`return-${baggageId}`);
                const returnQuantity = document.getElementById(`return-quantity-${baggageId}`);
                if (returnInput && returnQuantity) {
                    returnInput.value = quantity.toString();
                    returnQuantity.textContent = quantity.toString();
                }
            });
        }
        submitForm(apply);
    }

    function skipSelection() {
        document.querySelectorAll('#departBaggage input[type="hidden"]').forEach(input => {
            const idParts = input.id.split('-');
            if (idParts.length < 2) {
                console.error(`Invalid input ID format: ${input.id}`);
                return;
            }
            const baggageId = idParts[1];
            input.value = "0";
            document.getElementById(`depart-quantity-${baggageId}`).textContent = "0";
        });
        document.querySelectorAll('#returnBaggage input[type="hidden"]').forEach(input => {
            const idParts = input.id.split('-');
            if (idParts.length < 2) {
                console.error(`Invalid input ID format: ${input.id}`);
                return;
            }
            const baggageId = idParts[1];
            input.value = "0";
            document.getElementById(`return-quantity-${baggageId}`).textContent = "0";
        });
        selectedDepartBaggage = {};
        selectedReturnBaggage = {};
        document.getElementById('baggageForm').submit();
    }

    function closeModal(modalId) {
        document.getElementById(modalId)?.classList.add('hidden');
    }

    function displayError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
    }

    function clearError() {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = '';
    }
</script>
</body>
</html>