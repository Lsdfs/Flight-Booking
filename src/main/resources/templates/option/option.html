<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Booking Options</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, #fdeff2, #d3c8f1);
            margin: 0;
            padding: 0;
            text-align: center;
        }

        h1 {
            color: #d0021b;
        }

        .container {
            width: 80%;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .option h2 {
            font-size: 18px;
            margin: 0;
        }

        .option button {
            background: white;
            color: black;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .option button:hover {
            background: #d0021b;
            color: white;
        }

        #applyReturnPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        #applyReturnPopup.show {
            display: block;
        }

        #applyReturnPopup button {
            margin: 10px;
            padding: 10px 15px;
            border: none;
            background: #d0021b;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        #applyReturnPopup button:hover {
            background: #a00216;
        }

        img {
            display: block !important;
            width: auto;
            height: auto;
        }

        .modal {
            display: none;
        }

        .modal.show {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 600px;
            max-width: 90%;
        }
    </style>
</head>
<body>
<h1>Select Your Option</h1>
<div th:if="${error != null}" th:text="${error}" style="color: red;"></div>

<div class="container">
    <div class="option choose-seat">
        <img th:src="@{/image/seat.png}" src="/image/seat.png" alt="seat img" />
        <h2>Select your seat</h2>
        <button onclick="openModal('seatModal')">></button>
    </div>
    <div class="option choose-meal">
        <img th:src="@{/image/meal.png}" src="/image/meal.png" alt="meal img" />
        <h2>Select your meal</h2>
        <button onclick="openModal('mealModal')">></button>
    </div>
    <div class="option choose-baggage">
        <img th:src="@{/image/baggage.png}" src="/image/baggage.png" alt="baggage img" />
        <h2>Select your baggage</h2>
        <button onclick="openModal('baggageModal')">></button>
    </div>
</div>

<div th:replace="~{option/seat :: seatModal}" th:if="${booking != null}"></div>
<div th:replace="~{option/meal :: mealModal}" th:if="${booking != null}"></div>
<div th:replace="~{option/baggage :: baggageModal}" th:if="${booking != null}"></div>

<div id="applyReturnPopup">
    <p>Do you want to apply this selection to the return trip?</p>
    <button onclick="applyToReturnTrip(true)">Yes</button>
    <button onclick="applyToReturnTrip(false)">No</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const isRoundTrip = /*[[${booking != null && booking.flights != null && booking.flights.size() > 1}]]*/ false;
    const bookingId = /*[[${booking != null ? booking.id : 0}]]*/ 0;
    let currentService = '';

    function openModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.add("show");
            currentService = id.replace('Modal', '');
            if (!isRoundTrip) {
                let returnTab = document.getElementById(`return${currentService.charAt(0).toUpperCase() + currentService.slice(1)}Tab`);
                if (returnTab) returnTab.classList.add("hidden");
            }
        }
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove("show");
        }
    }

    function changeTab(service, trip) {
        const departSection = document.getElementById(`departure${service.charAt(0).toUpperCase() + service.slice(1)}`);
        const returnSection = document.getElementById(`return${service.charAt(0).toUpperCase() + service.slice(1)}`);
        if (departSection && returnSection) {
            departSection.classList.toggle("hidden", trip !== 'departure');
            returnSection.classList.toggle("hidden", trip !== 'return');

            let tabs = document.querySelectorAll(`#${service}Tabs .tab`);
            tabs.forEach(tab => tab.classList.remove("active"));
            const activeTab = document.querySelector(`#${service}Tabs .tab[onclick="changeTab('${service}', '${trip}')"]`);
            if (activeTab) activeTab.classList.add("active");
        }
    }

    function confirm(service) {
        if (isRoundTrip) {
            document.getElementById("applyReturnPopup").classList.add("show");
        } else {
            submitSelection(service);
        }
    }

    function applyToReturnTrip(apply) {
        document.getElementById("applyReturnPopup").classList.remove("show");
        if (!apply) {
            changeTab(currentService, 'return');
        } else {
            submitSelection(currentService);
        }
    }

    function submitSelection(service) {
        const idField = document.getElementById(`${service}Select`);
        if (!idField) {
            console.error(`Element with ID ${service}Select not found.`);
            return;
        }
        const selectedId = idField.value;
        const applyToReturn = !document.getElementById("applyReturnPopup").classList.contains("show");
        let endpoint = `/booking/select-${service}`;
        let params = `bookingId=${bookingId}&${service}Id=${selectedId}&applyToReturn=${applyToReturn}`;
        if (service === 'meal') {
            const quantityInput = document.getElementById('mealQuantity');
            if (quantityInput) {
                const quantity = quantityInput.value;
                params += `&quantity=${quantity}`;
            }
        }
        window.location.href = `${endpoint}?${params}`;
    }

    function adjustQuantity(change) {
        const qtyInput = document.getElementById('mealQuantity');
        if (qtyInput) {
            let currentQty = parseInt(qtyInput.value) || 0;
            qtyInput.value = Math.max(0, currentQty + change);
        }
    }
</script>
</body>
</html>