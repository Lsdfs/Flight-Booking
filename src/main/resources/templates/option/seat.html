<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Choose Your Preferred Seat</title>
    <style>
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 600px;
            max-width: 90%;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid #ff0000;
            font-weight: bold;
        }

        .passenger-info {
            background: #ff0000;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .priority-info {
            color: green;
            margin-bottom: 10px;
        }

        .seat-map {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .seat {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .seat.premium {
            background: #ff0000;
        }

        .seat.standard {
            background: #28a745;
        }

        .seat.extra-legroom {
            background: #00b7eb;
        }

        .seat.front-row {
            background: #6f42c1;
        }

        .seat.occupied {
            background: #ccc;
            cursor: not-allowed;
        }

        .seat.selecting {
            background: #ffc107;
        }

        .seat-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .seat-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-item div {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .hidden {
            display: none;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .popup button {
            margin: 0 10px;
            padding: 5px 10px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button.no-thanks {
            background: #ffc107;
            color: black;
        }

        button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
<div id="applyReturnPopup" class="popup hidden">
    <p>Do you want to apply this seat selection for the return trip?</p>
    <button onclick="applyToReturnTrip(true)">Yes</button>
    <button onclick="applyToReturnTrip(false)">No</button>
</div>

<div th:fragment="seatModal" id="seatModal" class="modal">
    <button class="close-btn" onclick="closeModal('seatModal')">X</button>
    <h2>Choose Your Preferred Seat</h2>
    <form id="seatForm" th:action="@{/seat/save}" method="post">
        <input type="hidden" name="bookingId" th:value="${bookingId}"/>
        <input type="hidden" name="flightId" th:value="${departFlight.id}"/>
        <input type="hidden" id="applyToReturnTrip" name="applyToReturnTrip" th:value="${applyToReturnTrip}"/>
        <div class="tab-container" id="seatTabs">
            <div class="tab active" onclick="changeTab('seat', 'depart')">Depart trip</div>
            <div class="tab" id="returnSeatTab" onclick="changeTab('seat', 'return')">Return trip</div>
        </div>

        <div id="departSeat">
            <div class="passenger-info">
                <p th:text="${passengerName}"></p>
                <p th:text="${departFlight.departure} + ' - ' + ${departFlight.destination}"></p>
            </div>
            <div class="priority-info">
                <p>Your ticket class gets priority to choose Premium seat for free.</p>
            </div>
            <div class="seat-labels">
                <span>A</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span>
            </div>
            <div th:each="seat : ${departSeats}"
                 th:classappend="'seat ' +
                    (${seat.seatClass.name() == 'PREMIUM'} ? 'premium' :
                    (${seat.seatClass.name() == 'STANDARD'} ? 'standard' :
                    (${seat.seatClass.name() == 'EXTRA_LEGROOM'} ? 'extra-legroom' : 'front-row')))
                    + (${seat.status.name() == 'OCCUPIED'} ? ' occupied' : '')
                    + (${#lists.contains(selectedDepartSeats, seat.id)} ? ' selecting' : '')"

                 th:onclick="${seat.status.name() == 'OCCUPIED'} ? '' : 'toggleSeat(\'depart\', ' + ${seat.id} + ')'"

                 th:text="${#strings.endsWith(seat.seatNumber, '1') || #strings.endsWith(seat.seatNumber, '2')}
                            ? ${#strings.substring(seat.seatNumber, 1)} : ''">
            </div>
            <div class="seat-legend">
                <div class="legend-item"><div style="background: #ff0000;"></div><span>Premium seat</span></div>
                <div class="legend-item"><div style="background: #28a745;"></div><span>Standard seat</span></div>
                <div class="legend-item"><div style="background: #00b7eb;"></div><span>Extra legroom seat</span></div>
                <div class="legend-item"><div style="background: #6f42c1;"></div><span>Front row seat</span></div>
                <div class="legend-item"><div style="background: #ffc107;"></div><span>Selecting seat</span></div>
                <div class="legend-item"><div style="background: #ccc;"></div><span>Occupied seat</span></div>
            </div>
            <div id="departSeatInputs"></div>
        </div>

        <div id="returnSeat" class="hidden">
            <div class="passenger-info">
                <p th:text="${passengerName}"></p>
                <p th:if="${#lists.size(booking.flights) > 1}" th:text="${booking.flights[1].departure} + ' - ' + ${booking.flights[1].destination}"></p>
            </div>
            <div class="priority-info">
                <p>Your ticket class gets priority to choose Premium seat for free.</p>
            </div>
            <div class="seat-labels">
                <span>A</span><span>B</span><span>C</span><span>D</span><span>E</span><span>F</span>
            </div>
            <div class="seat-map">
                <div th:each="seat : ${returnSeats}"
                     th:classappend="'seat ' +
                    (${seat.seatClass.name() == 'PREMIUM'} ? 'premium' :
                    (${seat.seatClass.name() == 'STANDARD'} ? 'standard' :
                    (${seat.seatClass.name() == 'EXTRA_LEGROOM'} ? 'extra-legroom' : 'front-row')))
                    + (${seat.status.name() == 'OCCUPIED'} ? ' occupied' : '')
                    + (${#lists.contains(selectedReturnSeats, seat.id)} ? ' selecting' : '')"

                     th:onclick="${seat.status.name() == 'OCCUPIED'} ? '' : 'toggleSeat(\'depart\', ' + ${seat.id} + ')'"

                     th:text="${#strings.endsWith(seat.seatNumber, '1') || #strings.endsWith(seat.seatNumber, '2')}
                            ? ${#strings.substring(seat.seatNumber, 1)} : ''">
                </div>
            </div>
            <div class="seat-legend">
                <div class="legend-item"><div style="background: #ff0000;"></div><span>Premium seat</span></div>
                <div class="legend-item"><div style="background: #28a745;"></div><span>Standard seat</span></div>
                <div class="legend-item"><div style="background: #00b7eb;"></div><span>Extra legroom seat</span></div>
                <div class="legend-item"><div style="background: #6f42c1;"></div><span>Front row seat</span></div>
                <div class="legend-item"><div style="background: #ffc107;"></div><span>Selecting seat</span></div>
                <div class="legend-item"><div style="background: #ccc;"></div><span>Occupied seat</span></div>
            </div>

            <div id="returnSeatInputs"></div>
        </div>

        <button type="button" onclick="showApplyReturnPopup()">Confirm</button>
        <button type="submit" class="no-thanks" onclick="skipSelection()">No, thanks</button>
    </form>
</div>

<script>
    let selectedDepartSeats = new Set();
    let selectedReturnSeats = new Set();

    document.addEventListener('DOMContentLoaded', function() {
        const applyToReturnTrip = document.getElementById('applyToReturnTrip').value;
        if (applyToReturnTrip !== 'yes') {
            document.getElementById('returnSeatTab').style.display = 'none';
            document.getElementById('returnSeat').style.display = 'none';
        }

        const departSeats = /*[[${selectedDepartSeats}]]*/ [];
        const returnSeats = /*[[${selectedReturnSeats}]]*/ [];
        departSeats.forEach(seatId => toggleSeat('depart', seatId, true));
        returnSeats.forEach(seatId => toggleSeat('return', seatId, true));
    });

    function changeTab(type, tab) {
        const returnSeatTab = document.getElementById('returnSeatTab');
        if (tab === 'return' && returnSeatTab.style.display === 'none') {
            return;
        }

        if (tab === 'depart') {
            document.getElementById('departSeat').classList.remove('hidden');
            document.getElementById('returnSeat').classList.add('hidden');
            document.querySelector('#seatTabs .tab:nth-child(1)').classList.add('active');
            document.querySelector('#seatTabs .tab:nth-child(2)').classList.remove('active');
        } else {
            document.getElementById('departSeat').classList.add('hidden');
            document.getElementById('returnSeat').classList.remove('hidden');
            document.querySelector('#seatTabs .tab:nth-child(1)').classList.remove('active');
            document.querySelector('#seatTabs .tab:nth-child(2)').classList.add('active');
        }
    }

    function toggleSeat(tab, seatId, initial = false) {
        const seatElement = document.querySelector(`#${tab}Seat .seat[onclick*="${seatId}"]`);
        const inputsContainer = document.getElementById(`${tab}SeatInputs`);
        let seatSet = (tab === 'depart') ? selectedDepartSeats : selectedReturnSeats;
        const inputName = (tab === 'depart') ? 'departSeatIds' : 'returnSeatIds';

        if (seatSet.has(seatId)) {
            seatSet.delete(seatId);
            seatElement.classList.remove('selecting');
            inputsContainer.querySelector(`input[value="${seatId}"]`).remove();
        } else {
            seatSet.add(seatId);
            seatElement.classList.add('selecting');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = inputName;
            input.value = seatId;
            inputsContainer.appendChild(input);
        }
    }

    function showApplyReturnPopup() {
        if (selectedDepartSeats.size === 0) {
            alert("Please select at least one seat for Depart trip before confirming.");
            return;
        }

        const applyToReturnTrip = document.getElementById('applyToReturnTrip').value;
        if (applyToReturnTrip === 'yes') {
            document.getElementById('applyReturnPopup').classList.remove('hidden');
        } else {
            submitForm(false);
        }
    }

    function applyToReturnTrip(apply) {
        document.getElementById('applyReturnPopup').classList.add('hidden');
        if (apply) {
            selectedReturnSeats = new Set(selectedDepartSeats);
            const returnInputsContainer = document.getElementById('returnSeatInputs');
            returnInputsContainer.innerHTML = '';
            selectedReturnSeats.forEach(seatId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'returnSeatIds';
                input.value = seatId;
                returnInputsContainer.appendChild(input);
                const seatElement = document.querySelector(`#returnSeat .seat[onclick*="${seatId}"]`);
                if (seatElement) seatElement.classList.add('selecting');
            });
            changeTab('seat', 'return');
        } else {
            changeTab('seat', 'return');
        }
        submitForm(apply);
    }

    function submitForm(applyToReturn) {
        const applyToReturnTrip = document.getElementById('applyToReturnTrip').value;
        if (applyToReturnTrip === 'yes' && selectedReturnSeats.size === 0) {
            alert("Please select at least one seat for Return trip before confirming.");
            return;
        }
        document.getElementById('seatForm').submit();
    }

    function skipSelection() {
        selectedDepartSeats.clear();
        selectedReturnSeats.clear();
        document.querySelectorAll('.seat.selecting').forEach(seat => seat.classList.remove('selecting'));
        document.getElementById('departSeatInputs').innerHTML = '';
        document.getElementById('returnSeatInputs').innerHTML = '';
        document.getElementById('seatForm').submit();
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }
</script>
</body>
</html>